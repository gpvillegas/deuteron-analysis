#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Thu Oct  3 16:02:48 2024

analysis his 2d histos

@author: boeglinw
"""
import numpy as np
import LT.box as B


#%%
hist_dir = './'

run = 21075
exp_file = f'EmPm_run{run}.data'
simc_file = 'EmPm_SIMC.data'


#%% load histos

# exp data
h2_exp = B.histo2d(file = hist_dir + exp_file)
h2_exp.xlabel='Pm'
h2_exp.ylabel='Em'
h2_exp.title = 'Exp. Data'

# SIMC data
h2_simc = B.histo2d(file = hist_dir + simc_file)
h2_simc.xlabel='Pm'
h2_simc.ylabel='Em'
h2_simc.title = 'SIMC Data'

#%% setup projections and plot

# xbin number

bin_range = np.arange(10,28)


Em_min = -0.05
Em_max_a = np.array([0.05, 0.07, 0.09, 0.11])
Em_max =  0.09

B.pl.close('all')
plot_all = True
plot_separate = False

#%% perfomr projections and integrate
def Em_integration(bin_range, Emin = Em_min, Emax = Em_max, plot_all = False):
    counts_exp = []
    counts_simc = []
    for nx in bin_range[:]:
        hexp = h2_exp.project_y(bins = [nx])
        hsimc = h2_simc.project_y(bins = [nx])
        
        counts_exp.append(hexp.sum(Emin, Emax))
        counts_simc.append(hsimc.sum(Emin, Emax))
        
        if plot_all:
            B.pl.figure()
            hexp.plot(filled = False)
            hsimc.plot(filled = False)
        
    counts_exp = np.array(counts_exp)
    counts_simc = np.array(counts_simc)
    
    # calculate ratios
    
    pm_values = h2_exp.x_bin_center[bin_range]
    
    R = counts_exp[:,0]/counts_simc[:,0]
    
    # assuming the errors in the exp. histo are correct
    dR = counts_exp[:,1]/counts_simc[:,0]
    
    return pm_values, R, dR
    
#%% 

for Em_max in Em_max_a:
    pm_values, R, dR = Em_integration(bin_range, Em_min, Em_max, plot_all = False)
    B.plot_exp(pm_values, R, dR, label = f'Em_max = {Em_max:.2e} (GeV)')
    
B.pl.legend()
B.pl.xlabel('Pm (GeV/c)')
B.pl.ylabel('Y_exp/Y_simc')
B.pl.title(f'Yield Ratios for {run}')


B.pl.savefig(f'Yield_ratios_{run}.pdf')
